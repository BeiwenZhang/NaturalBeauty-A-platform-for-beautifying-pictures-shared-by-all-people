<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>发布/编辑文章</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ckeditor4/4.16.2/full-all/ckeditor.js">
  <!-- 引入其他样式和脚本 -->
</head>

<body>

<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0 text-dark">发布/编辑文章</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a th:href="@{admin}">首页</a></li>
          <li class="breadcrumb-item active">文章管理</li>
          <li class="breadcrumb-item active">发布/编辑文章</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- Main content -->
<section class="content">
  <div class="card card-info p-3">
    <form id="articleForm" class="row">
      <!-- 保留输入文字和上传图片的部分 -->
    </form>
  </div>
</section>
<script th:src="@{/js/ckeditor.js}"></script>
<script>
  if (CKEDITOR.env.ie && CKEDITOR.env.version < 9)
    CKEDITOR.tools.enableHtml5Elements(document);

  CKEDITOR.config.height = 1000;
  CKEDITOR.config.width = 'auto';
  CKEDITOR.replace('articleField')
</script>

<script>
  $(function () {
    initSliderUploadContent();
  });

  function initSliderUploadContent() {
    var showSlider = $("input[name=slider]:checked").val();
    if (parseInt(showSlider)) {
      $("#sliderImgContent").show();
    } else {
      $("#sliderImgContent").hide();
      $("#upload-slider-content").hide();
    }
  }

  function addOrUpdateArticle(status, addFlag) {
    if (validArticle()) {
      Core.confirm("确认保存文章？", function () {
        $("#status").val(status);
        if (addFlag) {
          Core.postAjax("/article/add", $("#articleForm").serialize(), function (data) {
            if (data.status === 200) {
              CKEDITOR.instances.articleField.setData('');
              Core.load("#content", "article/add");
            }
            layer.msg(data.msg)
          });
        } else {
          Core.postAjax("/article/edit", $("#articleForm").serialize(), function (data) {
            layer.msg(data.msg)
          });
        }
      });
    }
  }

  function validArticle() {
    var content = CKEDITOR.instances.articleField.getData();
    if (content) {
      $("#articleContentMd").val(content);
      $("#articleContent").val(content);
      // 文章标签必填项校验
      var tags = [];
      $('input[name="tag"]:checked').each(function () {
        tags.push($(this).val());
      });
      if (tags.length > 0) {
        return true;
      } else {
        layer.msg("请选择文章标签！");
        return false;
      }
    } else {
      layer.msg("请输入文章内容！");
      return false;
    }
  }

  $(function () {
    /*上传图片*/
    $("#upload-img-btn").click(function () {
      $('#upload-cover-content').toggle();
      $(".coverUploader").upload({
        server: '/attachment/upload',
        swf: '/admin/img/Uploader.swf',
        imgAccept: true
      }, function (url, picker) {
        $("#coverImage").val(url);
        echoGtUploadResMethd(url, picker);
      });
    });

    $("#upload-slider-btn").click(function () {
      $('#upload-slider-content').toggle();
      $(".sliderUploader").upload({
        server: '/attachment/upload',
        swf: '/admin/img/Uploader.swf',
        imgAccept: true
      }, function (url, picker) {
        $("#sliderImg").val(url);
        echoGtUploadResMethd(url, picker);
      });
    });

    $('input[type=radio][name=slider]').change(function () {
      initSliderUploadContent();
    });

  });
</script>

<!-- 引入其他样式和脚本 -->
</body>

</html>
